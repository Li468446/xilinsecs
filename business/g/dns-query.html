<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOH 服务控制台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0071e3',
                        secondary: '#f5f5f7',
                        neutral: '#86868b',
                        dark: '#1d1d1f',
                        darkBg: '#121212',
                        darkCard: '#1e1e1e',
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .glass {
                background: rgba(255, 255, 255, 0.25);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.18);
            }
            .glass-dark {
                background: rgba(30, 30, 30, 0.7);
                backdrop-filter: blur(10px);
                -webkit-backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.08);
            }
            .text-shadow {
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            }
            .transition-all-300 {
                transition: all 300ms ease-in-out;
            }
            .card-hover {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-3px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            }
            .dark .card-hover:hover {
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            }
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 dark:from-darkBg dark:to-gray-900 font-sans text-dark dark:text-gray-100 transition-colors duration-500">
    <!-- 背景装饰元素 -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0 transition-opacity duration-700">
        <div class="absolute -top-20 -right-20 w-96 h-96 bg-primary/10 dark:bg-primary/5 rounded-full blur-3xl transition-all duration-700"></div>
        <div class="absolute top-1/3 -left-40 w-96 h-96 bg-primary/5 dark:bg-primary/3 rounded-full blur-3xl transition-all duration-700"></div>
    </div>

    <div class="relative z-10 container mx-auto px-4 py-12 max-w-4xl">
        <!-- 页面标题和主题切换 -->
        <header class="text-center mb-12 opacity-0 translate-y-4 animate-[fadeSlideUp_0.6s_0.2s_forwards]">
            <div class="flex justify-end mb-6">
                <button id="themeToggle" class="p-2 rounded-full glass hover:bg-white/30 dark:hover:bg-gray-800/50 transition-all-300">
                    <i class="fa fa-moon-o dark:hidden text-neutral"></i>
                    <i class="fa fa-sun-o hidden dark:inline text-yellow-400"></i>
                </button>
            </div>
            <h1 class="text-[clamp(2rem,5vw,3rem)] font-semibold tracking-tight text-shadow">
                DNS 查询工具
            </h1>
            <p class="text-neutral dark:text-gray-400 mt-4 text-lg max-w-xl mx-auto">
                快速查询域名的DNS解析信息，获取IP地址和相关记录
            </p>
        </header>

        <!-- 查询区域 -->
        <div class="glass dark:glass-dark rounded-2xl p-6 shadow-xl mb-8 transform hover:shadow-2xl transition-all-300 opacity-0 translate-y-4 animate-[fadeSlideUp_0.6s_0.4s_forwards]">
            <form id="dnsForm" class="flex flex-col md:flex-row gap-4">
                <div class="relative flex-1">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-neutral dark:text-gray-400">
                        <i class="fa fa-globe text-lg"></i>
                    </span>
                    <input
                        type="text"
                        id="domainInput"
                        placeholder="输入域名，例如 www.sec.hn.cn"
                        class="w-full pl-12 pr-4 py-4 rounded-xl bg-white/70 dark:bg-darkCard/70 border border-gray-200 dark:border-gray-700 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all-300 text-base"
                        value=""
                    >
                </div>

                <div class="relative md:w-48">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-neutral dark:text-gray-400">
                        <i class="fa fa-filter text-lg"></i>
                    </span>
                    <select
                        id="queryTypeSelect"
                        class="w-full pl-12 pr-4 py-4 rounded-xl bg-white/70 dark:bg-darkCard/70 border border-gray-200 dark:border-gray-700 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all-300 text-base appearance-none bg-[url('data:image/svg+xml;charset=US-ASCII,<svg width=\"20\" height=\"20\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M7 10l5 5 5-5z\" fill=\"%2386868b\"/></svg>')] bg-no-repeat bg-right pr-8 dark:bg-[url('data:image/svg+xml;charset=US-ASCII,<svg width=\"20\" height=\"20\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M7 10l5 5 5-5z\" fill=\"%23ffffff\"/></svg>')]"
                    >
                        <option value="1">IPv4 (A)</option>
                        <option value="28">IPv6 (AAAA)</option>
                        <option value="2">NS 记录</option>
                    </select>
                </div>

                <button
                    type="submit"
                    class="bg-primary hover:bg-primary/90 text-white font-medium py-4 px-8 rounded-xl transition-all-300 transform hover:scale-105 active:scale-95 flex items-center justify-center gap-2"
                >
                    <span>查询</span>
                    <i class="fa fa-search"></i>
                </button>
            </form>

            <!-- 历史记录 -->
            <div class="mt-6">
                <p class="text-sm text-neutral dark:text-gray-400 mb-2 flex items-center gap-1">
                    <i class="fa fa-history"></i> 最近查询
                </p>
                <div id="historyContainer" class="flex flex-wrap gap-2">
                    <!-- 历史记录将通过JS动态添加 -->
                </div>
            </div>
        </div>

        <!-- 加载状态 -->
        <div id="loadingIndicator" class="hidden justify-center py-12 glass dark:glass-dark rounded-2xl">
            <div class="flex flex-col items-center">
                <div class="w-12 h-12 border-4 border-gray-200 dark:border-gray-700 border-t-primary rounded-full animate-spin"></div>
                <p class="mt-4 text-neutral dark:text-gray-400">正在查询DNS信息...</p>
            </div>
        </div>

        <!-- 结果区域 -->
        <div id="resultContainer" class="hidden glass dark:glass-dark rounded-2xl overflow-hidden shadow-xl opacity-0 transition-all duration-500 transform translate-y-4">
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-semibold">查询结果</h2>
                <div class="flex gap-2">
                    <button id="copyButton" class="text-neutral dark:text-gray-400 hover:text-primary transition-all-300 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800">
                        <i class="fa fa-copy"></i>
                    </button>
                    <button id="jsonViewButton" class="text-neutral dark:text-gray-400 hover:text-primary transition-all-300 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800">
                        <i class="fa fa-code"></i>
                    </button>
                    <button id="clearButton" class="text-neutral dark:text-gray-400 hover:text-primary transition-all-300 p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800">
                        <i class="fa fa-trash"></i>
                    </button>
                </div>
            </div>

            <div class="p-6 max-h-[500px] overflow-auto">
                <!-- 结构化结果视图 -->
                <div id="structuredResultView" class="space-y-6"></div>

                <!-- JSON原始数据视图 -->
                <div id="jsonResultView" class="hidden">
                    <pre class="whitespace-pre-wrap" id="jsonContent"></pre>
                </div>
            </div>
        </div>

        <!-- 错误信息 -->
        <div id="errorContainer" class="hidden glass dark:glass-dark rounded-2xl p-6 shadow-xl">
            <div class="flex items-start gap-4">
                <div class="text-red-500 text-xl mt-1">
                    <i class="fa fa-exclamation-circle"></i>
                </div>
                <div>
                    <h3 class="font-semibold text-lg text-red-500">查询失败</h3>
                    <p id="errorMessage" class="mt-2 text-neutral dark:text-gray-400"></p>
                </div>
            </div>
        </div>

        <!-- 页脚 -->
        <footer class="mt-16 text-center text-neutral dark:text-gray-500 text-sm opacity-0 translate-y-4 animate-[fadeSlideUp_0.6s_0.6s_forwards]">
            <p>© 2023 DOH服务控制台 | 海口希灵赛斯</p>
            <p class="mt-2">DOH主机解析服务地址：<a id="dohEndpointLink" href="https://xl-d0h-server.xinnew.top/dns-query" class="text-primary hover:underline dark:text-primary/90" target="_blank">https://xl-d0h-server.xinnew.top/dns-query</a></p>
        </footer>
    </div>

    <!-- 复制成功提示 -->
    <div id="copyToast" class="fixed bottom-6 left-1/2 -translate-x-1/2 glass-dark text-white px-6 py-3 rounded-full shadow-2xl transform translate-y-20 opacity-0 transition-all-300 z-50">
        <i class="fa fa-check mr-2"></i> 已复制到剪贴板
    </div>

    <script>
        // 动画关键帧定义
        document.head.insertAdjacentHTML('beforeend', `
            <style>
                @keyframes fadeSlideUp {
                    from {
                        opacity: 0;
                        transform: translateY(10px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }
                @keyframes pulse {
                    0% {
                        transform: scale(1);
                    }
                    50% {
                        transform: scale(1.05);
                    }
                    100% {
                        transform: scale(1);
                    }
                }
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    20%, 60% { transform: translateX(-5px); }
                    40%, 80% { transform: translateX(5px); }
                }
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                .animate-pulse-slow {
                    animation: pulse 2s infinite;
                }
                .result-item {
                    animation: fadeSlideUp 0.4s ease forwards;
                    opacity: 0;
                }
                .result-item-delay-1 { animation-delay: 0.1s; }
                .result-item-delay-2 { animation-delay: 0.2s; }
                .result-item-delay-3 { animation-delay: 0.3s; }
                .result-item-delay-4 { animation-delay: 0.4s; }
                .geo-info {
                    transition: all 0.3s ease;
                }
                .geo-info-loading::after {
                    content: "";
                    display: inline-block;
                    width: 1em;
                    height: 1em;
                    border: 2px solid rgba(255,255,255,.3);
                    border-radius: 50%;
                    border-top-color: #fff;
                    animation: spin 1s ease-in-out infinite;
                    margin-left: 0.5em;
                    vertical-align: middle;
                }
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
            </style>
        `);

        // DOM元素
        const dnsForm = document.getElementById('dnsForm');
        const domainInput = document.getElementById('domainInput');
        const queryTypeSelect = document.getElementById('queryTypeSelect');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultContainer = document.getElementById('resultContainer');
        const structuredResultView = document.getElementById('structuredResultView');
        const jsonResultView = document.getElementById('jsonResultView');
        const jsonContent = document.getElementById('jsonContent');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const copyButton = document.getElementById('copyButton');
        const jsonViewButton = document.getElementById('jsonViewButton');
        const clearButton = document.getElementById('clearButton');
        const copyToast = document.getElementById('copyToast');
        const historyContainer = document.getElementById('historyContainer');
        const themeToggle = document.getElementById('themeToggle');

        // 视图切换状态
        let isJsonView = false;
        let currentResultData = null;

        // 存储查询历史和主题偏好
        let queryHistory = JSON.parse(localStorage.getItem('dnsQueryHistory')) || [];
        const MAX_HISTORY = 5;

        // 初始化主题
        function initTheme() {
            // 检查本地存储的主题偏好
            const savedTheme = localStorage.getItem('preferredTheme');
            const isDarkMode = savedTheme
                ? savedTheme === 'dark'
                : window.matchMedia('(prefers-color-scheme: dark)').matches;

            // 应用主题
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        // 切换主题
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');

            // 保存偏好
            localStorage.setItem('preferredTheme', isDark ? 'dark' : 'light');

            // 添加切换动画
            document.body.classList.add('animate-fadeIn');
            setTimeout(() => {
                document.body.classList.remove('animate-fadeIn');
            }, 300);
        }

        // 显示历史记录
        function displayHistory() {
            historyContainer.innerHTML = '';

            if (queryHistory.length === 0) {
                historyContainer.innerHTML = '<span class="text-neutral/70 dark:text-gray-500/70 text-sm">无查询记录</span>';
                return;
            }

            queryHistory.forEach(domain => {
                const chip = document.createElement('div');
                chip.className = 'px-3 py-1 bg-gray-100 dark:bg-gray-800 rounded-full text-sm hover:bg-gray-200 dark:hover:bg-gray-700 cursor-pointer transition-all-300';
                chip.textContent = domain;
                chip.addEventListener('click', () => {
                    domainInput.value = domain;
                    domainInput.focus();
                });
                historyContainer.appendChild(chip);
            });
        }

        // 添加到历史记录
        function addToHistory(domain) {
            // 移除可能存在的重复项
            queryHistory = queryHistory.filter(item => item !== domain);
            // 添加到开头
            queryHistory.unshift(domain);
            // 限制数量
            if (queryHistory.length > MAX_HISTORY) {
                queryHistory.pop();
            }
            // 保存到localStorage
            localStorage.setItem('dnsQueryHistory', JSON.stringify(queryHistory));
            // 更新显示
            displayHistory();
        }

        // 获取DNS记录类型名称
        function getRecordTypeName(typeId) {
            const recordTypes = {
                1: 'A (IPv4)',
                2: 'NS (名称服务器)',
                5: 'CNAME (规范名称)',
                6: 'SOA (起始授权机构)',
                15: 'MX (邮件交换)',
                16: 'TXT (文本)',
                28: 'AAAA (IPv6)',
                33: 'SRV (服务定位器)',
                43: 'DS (Delegation Signer)',
                46: 'RRSIG (DNSSEC签名)',
                53: 'NSEC (下一个安全)',
                65: 'HTTPS'
            };
            return recordTypes[typeId] || `类型 ${typeId}`;
        }

        // 格式化TTL值
        function formatTTL(ttl) {
            if (ttl < 60) return `${ttl} 秒`;
            if (ttl < 3600) return `${Math.floor(ttl / 60)} 分 ${ttl % 60} 秒`;
            return `${Math.floor(ttl / 3600)} 小时 ${Math.floor((ttl % 3600) / 60)} 分`;
        }

        // 获取IP地理位置信息 - 使用新的API接口
        async function getIpGeolocation(ip) {
            try {
                // 从API配置中获取DOH端点
                const response = await fetch('../../api/info.json');
                const apiConfig = await response.json();
                const dohEndpoint = apiConfig.api.doh.endpoint;
                
                // 新的IP查询接口
                const geoResponse = await fetch(`${dohEndpoint.replace('/dns-query', '/ip-info')}?ip=${ip}&token=dns-query`);
                if (!geoResponse.ok) {
                    throw new Error(`HTTP错误: ${geoResponse.status}`);
                }

                const data = await geoResponse.json();

                // 检查查询是否成功
                if (data.status !== "success") {
                    throw new Error("获取地理位置信息失败");
                }

                return data;
            } catch (error) {
                console.error('获取IP地理位置失败:', error);
                return null;
            }
        }

        // 格式化JSON为HTML（语法高亮）
        function formatJson(json) {
            if (typeof json !== 'string') {
                json = JSON.stringify(json, null, 2);
            }

            // 转义HTML特殊字符
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

            // 语法高亮
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+-]?\d+)?)/g, match => {
                let cls = 'text-primary'; // 键名和字符串
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'text-purple-600 dark:text-purple-400'; // 键名
                    } else {
                        cls = 'text-green-600 dark:text-green-400'; // 字符串值
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'text-blue-600 dark:text-blue-400'; // 布尔值
                } else if (/null/.test(match)) {
                    cls = 'text-orange-600 dark:text-orange-400'; // null
                } else if (!isNaN(match)) {
                    cls = 'text-red-600 dark:text-red-400'; // 数字
                }
                return `<span class="${cls}">${match}</span>`;
            }).replace(/(,|\{|\}|\[|\])/g, match => {
                return `<span class="font-bold">${match}</span>`;
            }).split('\n').map(line => {
                return `<div class="py-0.5">${line}</div>`;
            }).join('');
        }

        // 构建结构化结果视图
        function buildStructuredResult(data) {
            let html = '';

            // 查询信息卡片
            html += `
            <div class="glass dark:glass-dark rounded-xl p-5 shadow-md card-hover result-item">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                        <i class="fa fa-info"></i>
                    </div>
                    <h3 class="font-semibold text-lg">查询信息</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="text-neutral dark:text-gray-400">域名</p>
                        <p class="font-medium mt-1">${data.Question?.[0]?.name || '未知'}</p>
                    </div>
                    <div>
                        <p class="text-neutral dark:text-gray-400">查询类型</p>
                        <p class="font-medium mt-1">${getRecordTypeName(data.Question?.[0]?.type || 1)}</p>
                    </div>
                    <div>
                        <p class="text-neutral dark:text-gray-400">状态</p>
                        <p class="font-medium mt-1 ${data.Status === 0 ? 'text-green-600 dark:text-green-400' : 'text-amber-600 dark:text-amber-400'}">
                            ${data.Status === 0 ? '成功' : `状态码: ${data.Status}`}
                        </p>
                    </div>
                    <div>
                        <p class="text-neutral dark:text-gray-400">查询时间</p>
                        <p class="font-medium mt-1">${new Date().toLocaleString()}</p>
                    </div>
                </div>
            </div>
            `;

            // 标志信息卡片
            html += `
            <div class="glass dark:glass-dark rounded-xl p-5 shadow-md card-hover result-item result-item-delay-1">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                        <i class="fa fa-flag"></i>
                    </div>
                    <h3 class="font-semibold text-lg">标志信息</h3>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-sm">
                    <div class="text-center p-2 rounded-lg bg-gray-50 dark:bg-gray-800/50">
                        <p class="text-neutral dark:text-gray-400">截断 (TC)</p>
                        <p class="font-medium mt-1 ${data.TC ? 'text-amber-600 dark:text-amber-400' : 'text-green-600 dark:text-green-400'}">
                            ${data.TC ? '是' : '否'}
                        </p>
                    </div>
                    <div class="text-center p-2 rounded-lg bg-gray-50 dark:bg-gray-800/50">
                        <p class="text-neutral dark:text-gray-400">递归请求 (RD)</p>
                        <p class="font-medium mt-1 ${data.RD ? 'text-green-600 dark:text-green-400' : 'text-neutral dark:text-gray-500'}">
                            ${data.RD ? '是' : '否'}
                        </p>
                    </div>
                    <div class="text-center p-2 rounded-lg bg-gray-50 dark:bg-gray-800/50">
                        <p class="text-neutral dark:text-gray-400">递归可用 (RA)</p>
                        <p class="font-medium mt-1 ${data.RA ? 'text-green-600 dark:text-green-400' : 'text-neutral dark:text-gray-500'}">
                            ${data.RA ? '是' : '否'}
                        </p>
                    </div>
                    <div class="text-center p-2 rounded-lg bg-gray-50 dark:bg-gray-800/50">
                        <p class="text-neutral dark:text-gray-400">验证 (AD)</p>
                        <p class="font-medium mt-1 ${data.AD ? 'text-green-600 dark:text-green-400' : 'text-neutral dark:text-gray-500'}">
                            ${data.AD ? '是' : '否'}
                        </p>
                    </div>
                </div>
            </div>
            `;

            // 解析结果卡片
            if (data.Answer && data.Answer.length > 0) {
                html += `
                <div class="glass dark:glass-dark rounded-xl p-5 shadow-md card-hover result-item result-item-delay-2">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                            <i class="fa fa-server"></i>
                        </div>
                        <h3 class="font-semibold text-lg">解析结果 (${data.Answer.length})</h3>
                    </div>
                    <div class="space-y-4">
                `;

                data.Answer.forEach((answer, index) => {
                    // 为IP地址添加特殊样式
                    const isIpAddress = answer.type === 1 || answer.type === 28;
                    let dataValue = isIpAddress
                        ? `<span class="text-primary font-semibold text-lg">${answer.data}</span>`
                        : answer.data;

                    // 如果是IP地址且有地理位置信息，添加地理位置信息
                    if (isIpAddress && data.ipGeolocations && data.ipGeolocations[answer.data]) {
                        const geo = data.ipGeolocations[answer.data];
                        dataValue += `
                            <div class="mt-2 text-sm text-neutral dark:text-gray-400 geo-info">
                                <span class="mr-3 inline-flex items-center"><i class="fa fa-map-marker mr-1 text-red-500"></i>${geo.country || '未知国家/地区'} ${geo.city ? `(${geo.city})` : ''}</span>
                                <span class="mr-3 inline-flex items-center"><i class="fa fa-sitemap mr-1 text-blue-500"></i>${geo.as || '未知ASN'}</span>
                                <span class="inline-flex items-center"><i class="fa fa-wifi mr-1 text-green-500"></i>${geo.isp || '未知运营商'}</span>
                            </div>
                        `;
                    } else if (isIpAddress) {
                        // 显示加载状态
                        dataValue += `
                            <div class="mt-2 text-sm text-neutral dark:text-gray-400 geo-info geo-info-loading">
                                正在获取地理位置信息...
                            </div>
                        `;
                    }

                    html += `
                    <div class="p-3 rounded-lg bg-gray-50 dark:bg-gray-800/50 border border-gray-100 dark:border-gray-700/50">
                        <div class="flex flex-wrap justify-between items-start gap-2">
                            <div>
                                <p class="text-sm text-neutral dark:text-gray-400">${answer.name}</p>
                                <p class="mt-1">${dataValue}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs px-2 py-1 rounded-full bg-primary/10 text-primary">${getRecordTypeName(answer.type)}</p>
                                <p class="text-sm text-neutral dark:text-gray-400 mt-1">TTL: ${formatTTL(answer.TTL)}</p>
                            </div>
                        </div>
                    </div>
                    `;
                });

                html += `
                    </div>
                </div>
                `;
            } else {
                // 无解析结果
                html += `
                <div class="glass dark:glass-dark rounded-xl p-5 shadow-md result-item result-item-delay-2">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center text-amber-600 dark:text-amber-400">
                            <i class="fa fa-info-circle"></i>
                        </div>
                        <p class="text-neutral dark:text-gray-400">未找到该域名的${getRecordTypeName(queryTypeSelect.value)}记录</p>
                    </div>
                </div>
                `;
            }

            return html;
        }

        // 显示结果
        function showResult(data) {
            currentResultData = data;

            // 隐藏其他状态
            loadingIndicator.classList.replace('flex', 'hidden');
            errorContainer.classList.add('hidden');

            // 更新结构化视图
            structuredResultView.innerHTML = buildStructuredResult(data);

            // 更新JSON视图
            jsonContent.innerHTML = formatJson(data);

            // 确保显示结构化视图
            isJsonView = false;
            structuredResultView.classList.remove('hidden');
            jsonResultView.classList.add('hidden');
            jsonViewButton.innerHTML = '<i class="fa fa-code"></i>';

            // 显示结果容器
            resultContainer.classList.remove('hidden');

            // 添加动画
            setTimeout(() => {
                resultContainer.classList.remove('opacity-0', 'translate-y-4');
            }, 10);
        }

        // 切换视图（结构化/JSON）
        function toggleResultView() {
            isJsonView = !isJsonView;

            if (isJsonView) {
                structuredResultView.classList.add('hidden');
                jsonResultView.classList.remove('hidden');
                jsonViewButton.innerHTML = '<i class="fa fa-table"></i>';
            } else {
                structuredResultView.classList.remove('hidden');
                jsonResultView.classList.add('hidden');
                jsonViewButton.innerHTML = '<i class="fa fa-code"></i>';
            }
        }

        // 显示错误
        function showError(message) {
            // 隐藏其他状态
            loadingIndicator.classList.replace('flex', 'hidden');
            resultContainer.classList.add('hidden');

            // 显示错误
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');

            // 添加动画
            errorContainer.classList.add('animate-pulse-slow');
            setTimeout(() => {
                errorContainer.classList.remove('animate-pulse-slow');
            }, 2000);
        }

        // 显示加载状态
        function showLoading() {
            // 隐藏其他状态
            resultContainer.classList.add('hidden');
            errorContainer.classList.add('hidden');

            // 显示加载
            loadingIndicator.classList.replace('hidden', 'flex');
        }

        // 复制结果到剪贴板
        function copyToClipboard() {
            if (!currentResultData) return;

            const text = JSON.stringify(currentResultData, null, 2);
            navigator.clipboard.writeText(text).then(() => {
                // 显示提示
                copyToast.classList.remove('translate-y-20', 'opacity-0');
                setTimeout(() => {
                    copyToast.classList.add('translate-y-20', 'opacity-0');
                }, 2000);
            });
        }

        // 清除结果
        function clearResult() {
            resultContainer.classList.add('opacity-0', 'translate-y-4');
            setTimeout(() => {
                resultContainer.classList.add('hidden');
                currentResultData = null;
            }, 300);
        }

        // 执行DNS查询
        async function performDnsQuery(domain, queryType) {
            try {
                showLoading();

                // 从API配置中获取DOH端点
                const response = await fetch('../../api/info.json');
                const apiConfig = await response.json();
                const dohEndpoint = apiConfig.api.doh.endpoint;

                // 构建查询URL，包含查询类型参数
                const url = `${dohEndpoint}?name=${encodeURIComponent(domain)}&type=${queryType}`;

                // 发送请求
                const fetchResponse = await fetch(url, {
                    headers: {
                        'Accept': 'application/dns-json'
                    }
                });

                if (!fetchResponse.ok) {
                    throw new Error(`HTTP错误: ${fetchResponse.status}`);
                }

                const data = await fetchResponse.json();

                // 提取IP地址并获取地理位置信息（仅对IP类型记录）
                const ipAddresses = [];
                if (data.Answer && (queryType == 1 || queryType == 28)) {
                    data.Answer.forEach(answer => {
                        // 只处理A记录(IPv4)和AAAA记录(IPv6)
                        if (answer.type === 1 || answer.type === 28) {
                            ipAddresses.push(answer.data);
                        }
                    });

                    // 为每个IP获取地理位置信息
                    data.ipGeolocations = {};
                    for (const ip of ipAddresses) {
                        const geoData = await getIpGeolocation(ip);
                        if (geoData) {
                            data.ipGeolocations[ip] = geoData;
                        }
                    }
                }

                showResult(data);
                addToHistory(domain);

                // 如果有错误状态码，显示警告
                if (data.Status !== 0) {
                    const statusCodes = {
                        1: "格式错误 - 域名格式不正确",
                        2: "服务器失败 - 服务器内部错误",
                        3: "域名不存在 - 找不到该域名的记录",
                        4: "不支持 - 服务器不支持请求的操作",
                        5: "拒绝 - 服务器拒绝执行请求"
                    };

                    const errorMsg = statusCodes[data.Status] || `查询返回状态码: ${data.Status}`;
                    showError(errorMsg);
                }

            } catch (error) {
                console.error('查询失败:', error);
                showError(`查询失败: ${error.message}`);
            }
        }

        // 事件监听
        dnsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const domain = domainInput.value.trim();
            const queryType = queryTypeSelect.value;

            if (!domain) {
                // 添加抖动动画
                domainInput.classList.add('border-red-500');
                domainInput.classList.add('animate-[shake_0.5s]');
                setTimeout(() => {
                    domainInput.classList.remove('border-red-500', 'animate-[shake_0.5s]');
                }, 500);
                return;
            }

            performDnsQuery(domain, queryType);

            // 添加输入框动画
            domainInput.classList.add('scale-95');
            queryTypeSelect.classList.add('scale-95');
            setTimeout(() => {
                domainInput.classList.remove('scale-95');
                queryTypeSelect.classList.remove('scale-95');
            }, 200);
        });

        copyButton.addEventListener('click', copyToClipboard);
        jsonViewButton.addEventListener('click', toggleResultView);
        clearButton.addEventListener('click', clearResult);
        themeToggle.addEventListener('click', toggleTheme);

        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            displayHistory();
            
            // 从API配置中获取DOH端点并更新页脚链接
            fetch('../../api/info.json')
                .then(response => response.json())
                .then(apiConfig => {
                    const dohEndpoint = apiConfig.api.doh.endpoint;
                    document.getElementById('dohEndpointLink').href = dohEndpoint;
                    document.getElementById('dohEndpointLink').textContent = dohEndpoint;
                })
                .catch(error => {
                    console.error('获取API配置失败:', error);
                });
            
            // 自动聚焦输入框
            domainInput.focus();
            
            // 监听系统主题变化
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                // 只有在没有保存用户偏好时才响应系统变化
                if (!localStorage.getItem('preferredTheme')) {
                    if (e.matches) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                }
            });
        });
    </script>
</body>
</html>
